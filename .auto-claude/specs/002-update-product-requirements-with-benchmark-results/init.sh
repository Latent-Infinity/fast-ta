#!/bin/bash

# Auto-Build Environment Setup
# Generated by Planner Agent
# Spec: 002-update-product-requirements-with-benchmark-results

set -e

echo "========================================"
echo "fast-ta Benchmark Environment Setup"
echo "========================================"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Get the project root (parent of .auto-claude)
PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/../../../" && pwd)"
cd "$PROJECT_ROOT"

echo ""
echo -e "${YELLOW}Project root: $PROJECT_ROOT${NC}"
echo ""

# ============================================
# CHECK RUST TOOLCHAIN
# ============================================

echo "Checking Rust toolchain..."

if ! command -v cargo &> /dev/null; then
    echo -e "${RED}Error: cargo not found. Please install Rust from https://rustup.rs${NC}"
    exit 1
fi

RUST_VERSION=$(rustc --version)
echo -e "${GREEN}Found: $RUST_VERSION${NC}"

# ============================================
# BUILD WORKSPACE
# ============================================

echo ""
echo "Building workspace in release mode..."
echo ""

if cargo build --workspace --release; then
    echo -e "${GREEN}Build successful!${NC}"
else
    echo -e "${RED}Build failed. Please fix errors before continuing.${NC}"
    exit 1
fi

# ============================================
# RUN TESTS
# ============================================

echo ""
echo "Running workspace tests..."
echo ""

if cargo test --workspace; then
    echo -e "${GREEN}All tests passed!${NC}"
else
    echo -e "${RED}Tests failed. Please fix before running benchmarks.${NC}"
    exit 1
fi

# ============================================
# SUMMARY
# ============================================

echo ""
echo "========================================"
echo -e "${GREEN}Environment Ready!${NC}"
echo "========================================"
echo ""
echo "To run all benchmarks (30-60 minutes):"
echo "  cargo bench --workspace"
echo ""
echo "To run individual experiments:"
echo "  cargo bench --package fast-ta-experiments --bench e01_baseline"
echo "  cargo bench --package fast-ta-experiments --bench e02_running_stat"
echo "  cargo bench --package fast-ta-experiments --bench e03_ema_fusion"
echo "  cargo bench --package fast-ta-experiments --bench e04_rolling_extrema"
echo "  cargo bench --package fast-ta-experiments --bench e05_plan_overhead"
echo "  cargo bench --package fast-ta-experiments --bench e06_memory_writes"
echo "  cargo bench --package fast-ta-experiments --bench e07_end_to_end"
echo ""
echo "View results after benchmarking:"
echo "  open target/criterion/report/index.html"
echo ""
echo "Files to update after benchmarking:"
echo "  - benches/experiments/E01_baseline/REPORT.md"
echo "  - benches/experiments/E02_running_stat/REPORT.md"
echo "  - benches/experiments/E03_ema_fusion/REPORT.md"
echo "  - benches/experiments/E04_rolling_extrema/REPORT.md"
echo "  - benches/experiments/E05_plan_overhead/REPORT.md"
echo "  - benches/experiments/E06_memory_writes/REPORT.md"
echo "  - benches/experiments/E07_end_to_end/REPORT.md"
echo "  - docs/experiments/SUMMARY.md"
echo "  - docs/product-requirements.md"
echo ""
